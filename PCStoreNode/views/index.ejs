<!DOCTYPE html>
<html>
	<head>
		<%- include("./partials/header"); %>
	</head>
	<body>
		<%- include("./partials/navbar"); %>

		<h1><%= title %></h1>
		<p>Welcome to <%= title %></p>

		<table id="product-table">
			<tr>
				<td>Product Name</td>
				<td>Category</td>
				<td>Price</td>
			</tr>

		</table>

		<form id="login-form" method=POST, action=".">
		  	<label for="username">Username</label>
			<input id="form-username" name="username" type="text" placeholder="Your Username">
			<label for="password">Password</label>
			<input type="password" name="password" id="form-password" placeholder="Your Password">
			<input type="submit" value="login">
		<form>

		<%- include("./partials/footer"); %>
	</body>

	<script>
		fetch("http://localhost:8000/api/products/?format=json").then(response => response.json()).then(data => {
			console.log(data)
			data.forEach(product => {
				let table = document.getElementById("product-table")
				let newRow = document.createElement("tr")
				table.appendChild(newRow)

				let pName = document.createElement("td")
				pName.innerHTML = product["productName"]
				newRow.appendChild(pName)

				let cat = document.createElement("td")
				cat.innerHTML = product["category"]
				newRow.appendChild(cat)

				let price = document.createElement("td")
				price.innerHTML = product["price"]
				newRow.appendChild(price)

				let btnContainer = document.createElement("td")
				let btn = document.createElement("button")
				btn.innerHTML = "Add to cart"
				btn.onclick = `addCart(${product["productID"]})`
				btn.addEventListener("click", () => {
					addCart(product["productID"])
				});

				btnContainer.appendChild(btn)
				newRow.appendChild(btnContainer)
			})
		})

		let loginform = document.getElementById("login-form")
		loginform.addEventListener(
			"submit", 
			(event) => {
				event.preventDefault();

				let user = document.getElementById("form-username").value
				let pass = document.getElementById("form-password").value
				fetch("http://localhost:8000/token/", {
					method:"POST",
					headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json',
							// 'Authorization': `Token ${auth_token}`
						},
						body:JSON.stringify({username:user, password:pass})
				}).then(response => response.json()).then(function(data) {
					console.log(data)
					window.token = data
					sessionStorage.setItem("Token", window.token.token)
					console.log(window.token)
				})
			}, 
			true
		)

		function addCart(productID) {
			if (window.token) {
				fetch(
					`http://localhost:8000/basket/add-cart/${productID}`, 
					{
						method: "GET",
						headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json',
							'Authorization': JSON.stringify(window.token)
						}
					}
				).then(response => response.json()).then(data => console.log(data));
			} else {
				alert("Login Required");
			}
		}
	</script>
</html>
